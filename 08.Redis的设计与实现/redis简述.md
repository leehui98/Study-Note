# 0.概述

NoSql：非关系数据库，CAP定理、键值对存储

读写分离：写主库、读从库

读：10w，写：8w

3V+3高：海量、多样、实时；高并发、高可扩、高性能。

关系型数据库：ACID，原子性、一致性、独立性、持久性。

非关系型数据库：CAP，强一致性、可用性、分区容错性。

CAP的3进2：CA单点集群、CP、AP

redis是CP，分布式系统分区容错性必须实现，只能在一致性和可用性权衡。一致性（浏览量），可用性（不会挂）。

BASE：基本可用、软状态、最终一致。思想就是让系统放松对某一个可数据一致性的要求，换取系统整体伸缩性和性能上改观。

分布式：不同的多台服务器部署不同的服务模块，之间通过rpc通信和调用，对外提供服务和组内协作。

集群：不同的多台服务器部署相同的服务模块，通过分布式调度软件进行同一调度，对外提供服务和访问。

单进程：通过对epoll实现的，能显著提高CPU利用率。

redis默认16个库。

```redis
select 是选择数据库
dbsize 是查看当前数据库的key的数量
```

# 1.数据类型

字符串、哈希、列表、集合、有序集合。

string：最基本的类型，是二进制安全的（可以包含任何数据），字符串value最多可以是512M。

哈希：键值对集合

列表：底层是链表

集合：无序哈希表

有序集合：每个元素关联一个double类型的分数，跳转表

key

```shell
keys * #查询所有的key
exists key的名字 #判断key是否存在
move key db #移除db中的key
expire key 秒 #为给定key设置过期时间
ttl key #查询还有多少秒过期，-1是永不过期，-2是已过期
type key #查看key是什么类型
```

string...

# 2. redis持久化

RDB、AOF

RDB：redis会单独创建一个进程进行持久化，主进程不会进行IO操作，确保了高性能。过程是是先创建一个临时文件，持久化过程结束后，用临时文件替换上次持久化好的文件。但是最后一次持久化的文件可能会丢失部分数据。保存的是dump.rdb文件。BGSAVE后台异步。

AOF：变化是添加到file。以日志的形式来记录每个写操作，在启动之初读取该文件重新构造数据。

# 3.事务

是什么：可以一次执行多个命令，本质是一组命令的集合，一个事务中的所有命令都会序列化，按顺序地串行化执行而不会被其他命令插入，不许加塞。

MULTI：开启一个命令

EXEC：执行事务块内的所有命令

DISCARD：丢弃本次批处理操作

WATCH：监视一个key或多个key（被其他命令改动，那么事务被打断）

UNWATCH：取消watch命令对所有key的监视



redis事务的几个状态：

case1：正常执行MULTI-EXEC

case2：放弃事务MUTLTI-DISCARD

case3：全体连坐（要么全部成功，要么全部失败，命令没有加进去队列）

case4：冤有头债有主（谁错了就不执行，不是命令错误，找到了牙刷+杯子）

case5：watch监控



redis是否支持事务：redis部分支持事务，不是绝对强一致性



1. 悲观锁

   默认每次拿数据的时候都认为别人会修改，每次拿数据的时候都会上锁，这样别人想拿数据就会阻塞直到它拿到锁。并发性降低。

2. 乐观锁

   乐观，不会上锁，在更新的时候会判断在此期间别人有没有去更新这个数据，可以使用版本号机制。适用于多读。

3. CAS

# 4.主从复制

**是什么**

主从复制：主机更新后根据配置和策略，自动同步到备机的master/slaver机制，master以写为主，slave以读为主。

**能干吗**

作用：读写分离、容灾回复

**怎么玩**

1. 配从库，不配主库。
2. 从库配置：slave of 主库 ip 主库端口。每次与master断开之后，重新连接或者配置到config。
3. 修改配置文件
4. 常用三招：一主二仆、薪火相传（故障了就清除原有的数据，重新建立拷贝最新的）、反客为主（主机挂了成为主机）、

```redis
info replication：查看备份信息

SLAVEOF ip 端口：让哪个当作master

shutdown 关闭主机，从机上位

slaveof no one 从机上位
```

只有主机才可以写

**复制原理**

1. slave启动时向master发送一个sync同步命令
2. master启动存盘进程,手机所有接收到的修改数据集命令,在后台进程执行完毕后,master将传送整个数据文件到slave,已完成一次同步
3. 全量复制：slave服务在接收到数据库文件数据后,将其存盘并加载到内存中
4. 增量复制：master继续将修改命令传给slave,完成同步
5. 注意:  只要重新连接到master,一次完全同步将被自动执行

**哨兵模式(sentinel)**

自动挡的反客为主,自动判断主机是否故障,如果故障了根据投票数自动将从库转换为主库.

主机挂了,选票选出新的主机,谁的票数多记录谁是新的主机 

![](./image/sentinel.png)

